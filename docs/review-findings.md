# Summary: Update Instance Tagging for Unified Inventory Groups

## Goal
Modify the provisioner files to use consistent tagging that will automatically create the expected inventory groups when running `ansible-inventory --graph`. This will eliminate the need for manual group management and create a unified inventory structure across AWS and Hetzner Cloud providers.

## Expected Outcome
After implementing these changes, the `ansible-inventory --graph` command should output:
```
@all:
  |--@ungrouped:
  |--@aws_ec2:
  |  |--moria
  |  |--rivendell
  |--@aws_ec2_linux:
  |  |--rivendell
  |--@aws_ec2_windows:
  |  |--moria
  |--@hcloud_linux:
  |  |--hobbiton
  |--@windows:
  |  |--moria
  |--@linux:
  |  |--rivendell
  |  |--hobbiton
  |--@hcloud:
  |  |--hobbiton
```

## Required Changes

### 1. Update AWS Linux Provisioner (`provisioners/aws-linux.yml`)
Replace the current tags section (line 78-80):
```yaml
tags:
  Name: "{{ aws_instance_name }}"
  ansible_group: "linux"
```
With:
```yaml
tags:
  Name: "{{ aws_instance_name }}"
  platform: "linux"
```

### 2. Update AWS Windows Provisioner (`provisioners/aws-windows.yml`)
Replace the current tags section:
```yaml
tags:
  Name: "{{ aws_instance_name }}"
  ansible_group: "windows"
```
With:
```yaml
tags:
  Name: "{{ aws_instance_name }}"
  platform: "windows"
```

### 3. Update Hetzner Cloud Provisioner (`provisioners/hcloud.yml`)
Replace the current labels section:
```yaml
labels:
  ansible_group: "linux"
```
With:
```yaml
labels:
  platform: "linux"
```

### 4. Create/Update Dynamic Inventory Files

**Create `inventories/aws_ec2.yml`:**
```yaml
plugin: amazon.aws.aws_ec2
regions:
  - eu-north-1
keyed_groups:
  # Create platform groups (linux, windows)
  - key: tags.platform
    prefix: ""
    separator: ""
  # Create provider-specific platform groups (aws_ec2_linux, aws_ec2_windows)
  - key: tags.platform
    prefix: "aws_ec2"
    separator: "_"
filters:
  instance-state-name: ["running", "pending", "stopping", "stopped"]
```

**Create/Update `inventories/hcloud.yml`:**
```yaml
plugin: hetzner.hcloud.hcloud
keyed_groups:
  # Create platform groups (linux)
  - key: labels.platform
    prefix: ""
    separator: ""
  # Create provider-specific platform groups (hcloud_linux)
  - key: labels.platform
    prefix: "hcloud"
    separator: "_"
```

### 5. Update Group Variables Structure

**Rename existing group_vars directories:**
```
inventories/group_vars/aws/vars.yml → inventories/group_vars/aws_ec2/vars.yml
inventories/group_vars/aws_linux/vars.yml → inventories/group_vars/aws_ec2_linux/vars.yml
inventories/group_vars/aws_windows/vars.yml → inventories/group_vars/aws_ec2_windows/vars.yml
```

**Update any playbooks that reference the old groups:**
- Change `hosts: aws` to `hosts: aws_ec2`
- Change `hosts: aws_linux` to `hosts: aws_ec2_linux`
- Change `hosts: aws_windows` to `hosts: aws_ec2_windows`
- Update any group references in task conditions or variable lookups

## Benefits
1. **Automatic Group Management**: Groups are created automatically based on instance metadata
2. **Simplified Tagging**: Only requires a single `platform` tag/label per instance
3. **Provider Context**: Provider information is implicit in each inventory file
4. **Semantic Tags**: Tags reflect actual instance characteristics (platform) rather than Ansible-specific groups
5. **Scalable**: Easy to extend to additional providers or platforms
6. **Self-Documenting**: Instance purpose is clear from tags alone
7. **Clean Configuration**: No artificial group creation needed - uses plugin defaults
8. **Consistent Naming**: All AWS groups follow the `aws_ec2_*` pattern

## Technical Notes
- The `@aws_ec2` and `@hcloud` groups are created automatically by their respective inventory plugins
- Provider-specific groups (e.g., `@aws_ec2_linux`, `@hcloud_linux`) are generated by prefixing the platform with the provider name
- Global platform groups (e.g., `@linux`, `@windows`) are created without any prefix
- Using `@aws_ec2` instead of `@aws` eliminates the need for additional keyed group configuration
- The `aws_ec2_*` naming pattern provides consistency and future-proofs against other AWS services

## Testing
After implementation, verify the changes work by following the test procedure in `test/test_unified_inventory.md`.

## Migration Checklist
- [ ] Update AWS Linux provisioner tags
- [ ] Update AWS Windows provisioner tags  
- [ ] Update Hetzner Cloud provisioner labels
- [ ] Create/update AWS EC2 inventory file
- [ ] Create/update Hetzner Cloud inventory file
- [ ] Rename `inventories/group_vars/aws/` to `inventories/group_vars/aws_ec2/`
- [ ] Rename `inventories/group_vars/aws_linux/` to `inventories/group_vars/aws_ec2_linux/`
- [ ] Rename `inventories/group_vars/aws_windows/` to `inventories/group_vars/aws_ec2_windows/`
- [ ] Search and replace `hosts: aws` with `hosts: aws_ec2` in playbooks
- [ ] Search and replace `hosts: aws_linux` with `hosts: aws_ec2_linux` in playbooks
- [ ] Search and replace `hosts: aws_windows` with `hosts: aws_ec2_windows` in playbooks
- [ ] Test inventory graph output matches expected result