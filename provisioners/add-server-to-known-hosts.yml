---
#####
# Accept SSH host key of fresh server
#
# This implements Daniel Davis's suggestion from https://gist.github.com/shirou/6928012?permalink_comment_id=4059919#gistcomment-4059919
#
# Important additions:
# 
# - ssh-keyscan prints comments to stdout instead of stderr.
#   The -q option must be used to suppress these comments.
#   Otherwise the known_hosts module will fail when processing the comments.
#
# - Retries and delay are used to wait for the server to become available.
#   For Linux servers, the server is usually available on the 3rd try.
#   For Windows servers, the server is usually available on the 13th try.
#
# I was directed to the correct path by the stack overflow answer by nikobelia: https://stackoverflow.com/a/32338480
- name: "Show remote IP address"
  debug:
    msg: "Adding {{ remote_ip }} to known_hosts"

- name: "Remote IP must not be empty"
  assert:
    that:
      - remote_ip is defined
      - remote_ip | length > 0
    fail_msg: "The variable remote_ip must be defined and not empty"

- name: "Scan for SSH host keys"
  local_action:
    module: shell
    cmd: ssh-keyscan -q "{{ remote_ip }}"
  changed_when: False
  retries: 30
  delay: 10
  register: ssh_scan

- name: "Update known_hosts"
  local_action:
    module: known_hosts
    key: "{{ item }}"
    name: "{{ remote_ip }}"
  with_items: "{{ ssh_scan.stdout_lines }}"
